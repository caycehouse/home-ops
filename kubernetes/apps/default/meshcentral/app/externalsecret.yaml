---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: meshcentral
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: meshcentral-secret
    template:
      engineVersion: v2
      data:
        config.json: |
            {
                  "$schema": "https://raw.githubusercontent.com/Ylianst/MeshCentral/master/meshcentral-config-schema.json",
                  "settings": {
                        "plugins": {
                              "enabled": false
                        },
                        "cert": "meshcentral.${SECRET_DOMAIN}",
                        "port": 4430,
                        "AliasPort": 443,
                        "redirPort": 800,
                        "AgentPong": 300,
                        "TLSOffload": true
                  },
                  "domains": {
                        "": {
                              "minify": true,
                              "localSessionRecording": false,
                              "certUrl": "https://meshcentral.${SECRET_DOMAIN}",
                              "authStrategies": {
                                    "oidc": {
                                          "issuer": {
                                                "issuer": "https://auth.${SECRET_DOMAIN}"
                                          },
                                          "client": {
                                                "client_id": "meshcentral",
                                                "client_secret": "{{ .MESHCENTRAL_OAUTH_CLIENT_SECRET }}"
                                          },
                                          "custom": {
                                                "scope": [ "openid", "profile", "groups", "email" ]
                                          },
                                          "groups": {
                                                "siteadmin": [ "admins" ],
                                                "claim": "groups"
                                          },
                                          "newAccounts": true
                                    }
                              }
                        }
                  }
            }
  dataFrom:
    - extract:
        key: meshcentral
